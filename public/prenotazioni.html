<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="script.js" defer></script>
  <title>Calendari Prenotazioni - Calendario Annuale </title>
</head>
<body>
<main>
  
    <!-- ðŸ”§ Il tuo contenuto originale -->
 <div class="header-bar">
  <img src="wtp.jpeg" alt="Logo"/>
  <div class="nav-links">
    <a href="index.html">HOME</a>

    <!-- Dropdown SERVIZI -->
    <div class="dropdown">
      <a href="servizi-introduzione.html">SERVIZI ðŸ — </a>
      <div class="dropdown-content">

        <!-- Impianti Rete con sottomenÃ¹ -->
        <div class="submenu">
          <a href="#">Impianti Rete</a>
          <div class="submenu-content">
            <a href="servizi-fibra-ottica.html">Fibra Ottica</a>
            <a href="servizi-ftt-cab.html">FTTCab</a>
          </div>
        </div>

        <!-- Impianti Elettrici con sottomenÃ¹ -->
        <div class="submenu">
          <a href="#">Impianti Elettrici</a>
          <div class="submenu-content">
            <a href="servizi-impianti-industriali.html">Impianti Industriali</a>
            <a href="impianti-elettrici-civili.html">Impianti Civili</a>
          </div>
        </div>

      </div>
    </div>

    <a href="contatti.html">CONTATTI</a>
    <a href="chi-siamo.html">CHI SIAMO</a>

    <!-- PRENOTAZIONI spostato a destra -->
    <a href="prenotazioni.html" class="prenotazioni">PRENOTAZIONI</a>

    <a href="team.html">TEAM</a>
  </div>
</div>

  </div>
</div>

  <div class="wrap">
    <header>
      <h1>Calendari prenotazioni - Anno <span id="currentYear">2025</span></h1>
      <div class="controls">
        <button id="prevYear" class="btn">Â« Anno precedente</button>
        <div class="year-label" id="yearLabel">2025</div>
        <button id="nextYear" class="btn">Anno successivo Â»</button>
      </div>
    </header>

    <p class="small">Clicca su un giorno per segnare / togliere una prenotazione. I dati vengono salvati nel <strong>localStorage</strong> del browser.</p>

    <div class="months-grid" id="monthsGrid" aria-live="polite"></div>

    <div class="legend">
      <div class="chip"><span class="dot" style="background:var(--free)"></span> Giorno libero</div>
      <div class="chip"><span class="dot" style="background:var(--booked)"></span> Prenotato</div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal" id="modal">
    <div class="modal-card" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Dettagli giorno</h3>
      <div id="modalDate" class="small">--</div>
      <div class="modal-row">
        <input id="nameInput" class="input" placeholder="Nome prenotazione (opz.)">
        <input id="timeInput" type="time" class="input">
        <button id="saveBtn" class="btn">Salva</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button id="deleteBtn" class="btn">Elimina</button>
        <button id="closeBtn" class="btn">Chiudi</button>
      </div>
    </div>
  </div>

<script>
/* --- Config --- */
const LO_KEY = 'bookings';
let bookings = {};
let userId = localStorage.getItem('userId');
if (!userId) {
  userId = 'user-' + Math.random().toString(36).substring(2, 10);
  localStorage.setItem('userId', userId);
}
const monthsGrid = document.getElementById('monthsGrid');
const currentYearSpan = document.getElementById('currentYear');
let currentYear = new Date().getFullYear();
const locale = 'it';
const startWeekOnMonday = true;

/* --- Modal --- */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalDate = document.getElementById('modalDate');
const nameInput = document.getElementById('nameInput');
const timeInput = document.getElementById('timeInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const closeBtn = document.getElementById('closeBtn');
let activeDate = null;
let activeElem = null;

/* --- Render calendario --- */
function renderYear(year){
  monthsGrid.innerHTML = '';
  currentYearSpan.textContent = year;
  for(let m=0;m<12;m++){
    monthsGrid.appendChild(createMonthCard(year,m));
  }
}

function createMonthCard(year,monthIndex){
  const card = document.createElement('div');
  card.className = 'month-card';
  const monthName = new Date(year,monthIndex,1).toLocaleString(locale,{month:'long'});
  const header = document.createElement('div'); header.className='month-header';
  header.innerHTML = `<div class="month-title">${monthName.charAt(0).toUpperCase()+monthName.slice(1)} ${year}</div>`;
  card.appendChild(header);

  const weekdays = document.createElement('div'); weekdays.className='weekdays';
  const baseWeekdays = [];
  for(let i=0;i<7;i++){
    let dayIndex = startWeekOnMonday ? ((i+1)%7) : i;
    const d = new Date(2021,7,dayIndex+1);
    baseWeekdays.push(d.toLocaleString(locale,{weekday:'short'}).slice(0,2));
  }
  weekdays.innerHTML = baseWeekdays.map(d=>`<div>${d}</div>`).join('');
  card.appendChild(weekdays);

  const days = document.createElement('div'); days.className='days';
  const firstOfMonth = new Date(year,monthIndex,1);
  const lastOfMonth = new Date(year,monthIndex+1,0);
  let startDay = firstOfMonth.getDay();
  if(startWeekOnMonday) startDay = (startDay===0)?6:startDay-1;

  for(let i=0;i<startDay;i++){
    const blank = document.createElement('div'); blank.className='day out'; days.appendChild(blank);
  }

  for(let d=1; d<= lastOfMonth.getDate(); d++){
    const date = new Date(year,monthIndex,d);
    const iso = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
    const el = document.createElement('button'); el.className='day free'; el.setAttribute('data-date', iso);
    el.innerHTML = `<div class="num">${d}</div>`;
    if(bookings[iso]){
      updateDayElement(el, bookings[iso]);
    }
    el.addEventListener('click', ()=> openModal(iso, el));
    days.appendChild(el);
  }

  card.appendChild(days);
  return card;
}

/* --- Modal functions --- */
function openModal(iso, elem){
  if (bookings[iso] && bookings[iso].userId !== userId) {
    alert("Questo giorno Ã¨ giÃ  prenotato da un altro utente.");
    return;
  }
  activeDate = iso; activeElem = elem;
  const d = new Date(iso);
  modalTitle.textContent = 'Dettagli: '+d.toLocaleDateString(locale, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  modalDate.textContent = iso;
  nameInput.value = bookings[iso] ? bookings[iso].name||'' : '';
  timeInput.value = bookings[iso] ? bookings[iso].time||'' : '';
  modal.classList.add('show');
}
function closeModal(){ modal.classList.remove('show'); activeDate=null; activeElem=null }

saveBtn.addEventListener('click', async ()=>{
  if(!activeDate) return;
  const name = nameInput.value.trim();
  const time = timeInput.value;
  if(!name || !time){ alert("Inserisci nome e orario!"); return; }

  if(!confirm(`Confermi la prenotazione il ${activeDate} alle ${time}?`)) return;

  const data = { date: activeDate, name, time, userId };
  try {
    const res = await fetch('https://miosito-nodejs.onrender.com/api/bookings', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if(json.success){
      bookings[activeDate] = {name, time, userId, ts: Date.now()};
      updateDayElement(activeElem, bookings[activeDate]);
      closeModal();
    } else {
      alert('Errore server: '+(json.error||''));
    }
  } catch(e){
    console.error(e);
    alert('Errore di rete o server');
  }
});

deleteBtn.addEventListener('click', async () => {
  if (!activeDate) return;
  try {
    await fetch(`https://miosito-nodejs.onrender.com/api/bookings/${activeDate}`, { 
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    bookings[activeDate] = undefined;
    if(activeElem){
      activeElem.classList.remove('booked');
      activeElem.classList.add('free');
      activeElem.title = '';
    }
    alert("Prenotazione eliminata con successo!");
    closeModal();
  } catch(e){
    console.error(e);
    alert('Errore durante l\'eliminazione');
  }
});

closeBtn.addEventListener('click', closeModal);
modal.addEventListener('click',(e)=>{if(e.target===modal) closeModal();});

function updateDayElement(el, booking){
  if(el){
    el.classList.remove('free');
    el.classList.add('booked');
    el.title = booking.name ? `Prenotato: ${booking.name} (${booking.time})` : 'Prenotato';
    el.style.cursor = booking.userId && booking.userId !== userId ? "not-allowed" : "pointer";
  }
}

document.getElementById('prevYear').addEventListener('click', ()=>{ currentYear--; renderYear(currentYear); });
document.getElementById('nextYear').addEventListener('click', ()=>{ currentYear++; renderYear(currentYear); });

async function refreshBookings(){
  try {
    const res = await fetch('https://miosito-nodejs.onrender.com/api/bookings');
    const newBookings = await res.json();
    bookings = newBookings.bookings || newBookings;

    document.querySelectorAll('.day').forEach(el => {
      const date = el.getAttribute('data-date');
      if (bookings[date]) updateDayElement(el, bookings[date]);
      else { el.classList.remove('booked'); el.classList.add('free'); el.title = ''; }
    });
  } catch (e) { console.error('Errore durante il refresh:', e); }
}

setInterval(refreshBookings, 3000);
renderYear(currentYear);
refreshBookings();

</script>
</main>
</body>
</html>
